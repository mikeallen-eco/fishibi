# load libraries and data
```{r}
library(dplyr)
library(readxl)
'%notin%' <- Negate('%in%')

# read in raw reads file from obitools
f <- read.table("data/merged.uni.c10.l140.L190.cln.tag.ann.srt.tab2.txt", 
                sep="\t", header=TRUE) %>%
  select(-starts_with("obiclean"),-id,-definition) %>%
  rename(best_id = starts_with("best_id")) %>%
  select(rank, order_name, family_name, species_name, scientific_name, 
         count, match = best_id, starts_with("sample"), sequence)

# write.csv(f, file = "output/raw_fish_table.csv", row.names = F)

# read in sample data file
s <- read_xlsx("data/1 2022 NJDEP eDNA Sample Log FINAL_ No Highlights.xlsx") %>%
  rename(set = 11, well_orig = 12, run = 13) %>%
  mutate(well = case_when(substr(well_orig, 2,3) %in% c("10", "11", "12") ~ well_orig,
                          TRUE ~ paste0(substr(well_orig,1,1), "0", substr(well_orig,2,2))),
         sample = paste0("sample.",run, set, well))

# make a lookup table between run/set/well sample number and real sample names
samp_lookup <- select(s, sample, t) %>%
  mutate(real_names = gsub(pattern = " ", replacement = "_", x = t))

# assign real names to sample columns
cols <- data.frame(sample = colnames(select(f, starts_with("sample.")))) %>%
  left_join(samp_lookup, by = "sample") %>%
  mutate(real_names = ifelse(is.na(real_names), sample, real_names))

# change sample codes in raw reads table to real sample names
colnames(f)[8:129] <- cols$real_names
f$seqid <- paste0("seq",1:nrow(f))

# select out just the samples
fs <- f %>%
  select(seqid, rank, order_name, family_name, species_name, scientific_name, 
         count, match, starts_with("eDNA"), sequence)
sum(select(fs, starts_with("eDNA")))

# select out just the negatives
fn <- f %>%
  select(seqid, rank, order_name, family_name, species_name, scientific_name, 
         count, match, starts_with("ENC"), starts_with("FNC"), starts_with("PCR"), sequence)
sum(select(fn, starts_with("ENC"), starts_with("FNC"), starts_with("PCR")))

# select out just the "extra samples"
fe <- f %>%
  select(seqid, rank, order_name, family_name, species_name, scientific_name, 
         count, match, starts_with("sample."), sequence)

```
# remove humans, mice, and non-fish
```{r}
# filter out non-fish - samples
fs2 <- fs %>%
  filter(order_name %notin% c("Primates", "Rodentia", "Anseriformes", "Caudata", "Galliformes", "Testudines",
                              "Passeriformes", "Pelecaniformes"))
sum(select(fs2, starts_with("eDNA")))

# filter out non-fish - negatives
fn2 <- fn %>%
  filter(order_name %notin% c("Primates", "Rodentia", "Anseriformes", "Caudata", "Galliformes", "Testudines",
                              "Passeriformes", "Pelecaniformes"))

fn2$seqmax <- apply(fn2[,9:17],1, max)

```
# subtract contamination found in negative controls
```{r}
# add the max reads by sequence in all the negatives
fs3a <- fs2 %>%
  left_join(select(fn2, seqid, seqmax), by = "seqid")
fs3 <- fs3a

colnames(fs3) # 9:92 are the samples

# zero out samples with less reads of a sequence than the max contamination among negative of that sequence
for(i in 9:92){
  tmp <- fs3a[,i] - fs3a$seqmax
  tmp2 <- as.numeric(ifelse(tmp<0,0,tmp))
  fs3[,i] <- tmp2
}

# count remaining reads in samples
sum(select(fs3, starts_with("eDNA")))


```

